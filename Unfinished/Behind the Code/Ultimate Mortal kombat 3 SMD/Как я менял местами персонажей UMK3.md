# Как я менял местами персонажей UMK3

## Введение

Для многих, включая меня, Ultimate Mortal Kombat 3 была одной из самых любимых игр детства. Давно хотелось разобраться, как она устроена, но всё никак не доходили руки. Теперь настал подходящий момент. Я решил начать с чего-то простого и наглядного, а именно поменять местами портрет и самого персонажа.
В этой статье подробно рассмотрим процесс замены бойца и его изображения на экране выбора, на примере изменения Noob Saibot на Human Smoke. Этот выбор не случаен — портрет Noob Saibot самый простой, использует минимум цветов и тайлов.
Далее шаг за шагом опишу, какие действия выполнял, чтобы успешно заменить персонажей.

> [!NOTE]
> Для работы я использовать Американский ром `Ultimate Mortal Kombat 3 (USA)`

## Попытка поменять персонажа

> [!NOTE]
> На момент подготовки статьи в DataCrystal имелась лишь одна подкатегория — RAM Map, поэтому другие разделы, особенно Tutorial, я не использовал.

Для начала решил изучить уже известные адреса в игре. Зашел на [датакристал](https://datacrystal.tcrf.net/wiki/Ultimate_Mortal_Kombat_3_(Genesis)), обнаружил, что у данной игры была только одна подкатегория [RAM map](https://datacrystal.tcrf.net/wiki/Ultimate_Mortal_Kombat_3_(Genesis)/RAM_map). В ней нашёл интересное значение по адресу `126`, где хранится информация о текущем выбранном персонаже.

```xml
P1 Character:
0x00 = Kano
0x01 = Sonya
0x02 = Jax
0x03 = Nightwolf
0x04 = Unmasked Sub-Zero
0x05 = Stryker
0x06 = Sindel
0x07 = Sektor
0x08 = Cyrax
0x09 = Kung Lao
0x0a = Kabal
0x0c = Shang Tsung
0x0d = Liu Kang
0x0e = Smoke
0x0f = Kitana
0x10 = Jade
0x11 = Mileena
0x12 = Scorpion
0x13 = Reptile
0x14 = Ermac
0x15 = Classic Sub-Zero
0x16 = Human Smoke
0x17 = Noob Saibot
0x18 = Rain
```

Сначала я решил попытаться испытать удачу и найти эту последовательность напрямую. Для этого я взял изображение с выбором персонажей и составил последовательность, предполагая, что она будет идти слева направо сверху вниз.

![PlayerSelect](images\PlayerSelect.png)

Я взял значение первых 3-х персонажей(`18 13 05`) и попытался их найти. Ожидаемо, безуспешно. Тогда решил проверить вариант с 16-битными значениями, предположив, что каждому бойцу выделено по два байта. Поиск по последовательности `00 18 00 13 00 05` дал результат — единственное совпадение по адресу `DFC8`.

![SearchResult](images\SearchResult.png)

Посмотрел дальше, и вся остальная последовательность совпадает. Для теста попробовал поменять Rain на Shao Khan (`1B`), и оказалось, что где-то еще лежат дефолтные значения для первого и второго персонажей, так как чтобы изменения вступили в силу, нужно сначала переключиться на другого персонажа, а потом снова перейти на предыдущего.

![ChangeResult](images\ChangeResult.gif)

Чтобы не тратить время на поиск нужных значений, учитывая, что в роме их 2234 и 920 соответственно, я решил взять какой-нибудь хак, в котором эти значения изменены. Затем я сравнил изменённый файл с оригинальным с помощью WinMerge и нашёл нужные места. Для этого я выбрал `Ultimate Mortal Kombat 3 - Arcade Hack v0.6 by Nemesis_c`

![PlayerSelectUMK3AH](images\PlayerSelectUMK3AH.png)

Изучив отличия, я обнаружил, что изменения касаются адресов `D43E` и `D446`. Если хотите изменить начальных персонажей, нужно редактировать эти значения.

## Попытка поменять портрет

